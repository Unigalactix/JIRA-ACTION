name: CI Workflow

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ci-pipeline:
    runs-on: ubuntu-latest
    steps:
      - name: Checklist
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract Jira Key
        id: jira
        uses: actions/github-script@v7
        with:
          script: |
            // Try to find key in branch name or PR title
            const branch = context.payload.pull_request.head.ref;
            const title = context.payload.pull_request.title;
            const regex = /[A-Z]+-\d+/;
            const match = branch.match(regex) || title.match(regex);
            if (match) {
              core.setOutput('issueKey', match[0]);
              console.log(`Found Jira Key: ${match[0]}`);
            } else {
              console.log("No Jira key found.");
              core.setOutput('issueKey', '');
            }

      - name: Jira Comment - CI Started
        if: steps.jira.outputs.issueKey != ''
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ steps.jira.outputs.issueKey }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `CI pipeline started for PR #${process.env.PR_NUMBER}. [View Logs](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `CI checkout completed.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Setup Dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Jira Comment - Runtime Ready
        if: steps.jira.outputs.issueKey != ''
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ steps.jira.outputs.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `CI runtime environment ready.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Build (.NET)
        run: echo "Building..." # Replace with actual dotnet build

      - name: Jira Comment - Build Success
        if: steps.jira.outputs.issueKey != ''
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ steps.jira.outputs.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Build completed successfully.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Test (.NET)
        run: echo "Testing..." # Replace with actual dotnet test

      - name: Jira Comment - Test Success
        if: steps.jira.outputs.issueKey != ''
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ steps.jira.outputs.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `All unit tests passed.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Lint
        run: echo "Linting..."

      - name: Jira Comment - Lint Success
        if: steps.jira.outputs.issueKey != ''
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ steps.jira.outputs.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Lint and static analysis checks passed.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript # or csharp, python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Jira Comment - Security Success
        if: steps.jira.outputs.issueKey != ''
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ steps.jira.outputs.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Security scan passed — no blocking issues.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Dependency Audit
        run: npm audit || true # or dotnet list package --vulnerable

      - name: Jira Comment - Dependency Success
        if: steps.jira.outputs.issueKey != ''
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ steps.jira.outputs.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Dependency scan OK — no critical alerts.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Jira Comment - CI Summary
        if: always() && steps.jira.outputs.issueKey != ''
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ steps.jira.outputs.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `CI completed — Build/Test/Security: All Passed.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });
