name: CD Workflow

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract Jira Key
        id: jira
        uses: actions/github-script@v7
        with:
          script: |
            const msg = context.payload.head_commit.message;
            const regex = /[A-Z]+-\d+/;
            const match = msg.match(regex);
            if (match) {
              core.setOutput('issueKey', match[0]);
              console.log(`Found Jira Key in commit: ${match[0]}`);
            } else {
              console.log("No Jira key found in commit message.");
              core.setOutput('issueKey', '');
            }

      - name: Jira Comment - Deploy Start
        if: steps.jira.outputs.issueKey != ''
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ steps.jira.outputs.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `PR merged — starting deployment pipeline.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Deployment checkout completed.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Publish Artifacts
        run: echo "Publishing..." # e.g. dotnet publish

      - name: Jira Comment - Publish Done
        if: steps.jira.outputs.issueKey != ''
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ steps.jira.outputs.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `dotnet publish completed — artifacts ready.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Upload Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: app-package
          path: . 

      - name: Deploy to Azure
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'example-app'
          package: .
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}

      - name: Jira Comment - Deployed
        if: steps.jira.outputs.issueKey != ''
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ steps.jira.outputs.issueKey }}
          DEPLOY_URL: 'https://example-app.azurewebsites.net' # Replace with actual logic to get url
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Deployment succeeded: ${process.env.DEPLOY_URL}.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Smoke Tests
        run: echo "Running smoke tests..."

      - name: Jira Comment - Smoke Tests Pass
        if: steps.jira.outputs.issueKey != ''
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ steps.jira.outputs.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Smoke tests passed — application healthy.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Jira Comment - Final Summary
        if: steps.jira.outputs.issueKey != ''
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ steps.jira.outputs.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Deployment finished — all pipeline checks passed. Transitioning issue to Done.`,
              transition: "Done",
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });
