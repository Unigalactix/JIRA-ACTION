name: Event Workflow (Agent)

on:
  repository_dispatch:
    types: [jira-webhook]

jobs:
  run-agent:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Jira Comment - Trigger
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ github.event.client_payload.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `GitHub automation triggered for ${process.env.ISSUE_KEY}.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Dotnet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
          
      - name: Jira Comment - Runtime
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ github.event.client_payload.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Runtime environment ready for Agent execution.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Jira Comment - Agent Input
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ github.event.client_payload.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Agent instructions prepared from Jira input.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Run Copilot Agent (Script)
        env:
          ISSUE_KEY: ${{ github.event.client_payload.issueKey }}
          REPOSITORY: ${{ github.repository }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          pip install requests python-dotenv
          python copilot_agent/lib/generate.py

      - name: Jira Comment - Agent Done
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ github.event.client_payload.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Copilot Agent processed request and generated artifacts.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Create Feature Branch
        id: create_branch
        run: |
          BRANCH="feature/${{ github.event.client_payload.issueKey }}"
          echo "BRANCH_NAME=$BRANCH" >> $GITHUB_ENV
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b $BRANCH

      - name: Jira Comment - Branch Created
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ github.event.client_payload.issueKey }}
          BRANCH: ${{ env.BRANCH_NAME }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Branch created: ${process.env.BRANCH}.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Commit and Push
        run: |
          git add .
          git commit -m "Auto-generated fixes for ${{ github.event.client_payload.issueKey }}"
          git push origin ${{ env.BRANCH_NAME }}

      - name: Jira Comment - Pushed
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ github.event.client_payload.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Code updates pushed by automation bot.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Create Pull Request
        id: create_pr
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ github.event.client_payload.issueKey }}
          BRANCH: ${{ env.BRANCH_NAME }}
        with:
          script: |
            const { repo, owner } = context.repo;
            const pr = await github.rest.pulls.create({
              owner,
              repo,
              title: `[${process.env.ISSUE_KEY}] Automated Fixes`,
              head: process.env.BRANCH,
              base: 'main',
              body: `Automated PR for ${process.env.ISSUE_KEY} generated by Copilot Agent.`
            });
            core.setOutput('pr_url', pr.data.html_url);
            core.setOutput('pr_number', pr.data.number);

      - name: Jira Comment - PR Created
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ github.event.client_payload.issueKey }}
          PR_URL: ${{ steps.create_pr.outputs.pr_url }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Pull Request created: [View PR](${process.env.PR_URL}).`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Jira Comment - Mid Summary
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ github.event.client_payload.issueKey }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Progress update available. [View Logs](${process.env.RUN_URL})`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });

      - name: Jira Comment - Final Summary
        if: always()
        uses: actions/github-script@v7
        env:
          ISSUE_KEY: ${{ github.event.client_payload.issueKey }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        with:
          script: |
            const jira = require('./.github/scripts/jira.js');
            await jira({
              issueKey: process.env.ISSUE_KEY,
              comment: `Agent summary posted â€” code, branch, and PR ready.`,
              baseUrl: process.env.JIRA_BASE_URL,
              email: process.env.JIRA_USER_EMAIL,
              token: process.env.JIRA_API_TOKEN
            });
